{
	"name": "openData_Course_AttachVenues",
	"properties": {
		"folder": {
			"name": "openDataExport"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "openData_Cache_Courses",
						"type": "DatasetReference"
					},
					"name": "courses"
				},
				{
					"dataset": {
						"referenceName": "cosmosDb_Venues",
						"type": "DatasetReference"
					},
					"name": "Venues"
				},
				{
					"dataset": {
						"referenceName": "openData_Cache_Regions",
						"type": "DatasetReference"
					},
					"name": "Regions"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "openData_Export_Courses",
						"type": "DatasetReference"
					},
					"name": "coursesExport"
				}
			],
			"transformations": [
				{
					"name": "splitByLocationType"
				},
				{
					"name": "JoinCourseVenue"
				},
				{
					"name": "joinCourses"
				},
				{
					"name": "SortByProvider"
				},
				{
					"name": "Join1"
				},
				{
					"name": "Flatten1"
				}
			],
			"script": "source(output(\n\t\tProviderUKPRN as string,\n\t\tCourseId as string,\n\t\tLearnAimRef as string,\n\t\tCourseName as string,\n\t\tDeliveryMode as string,\n\t\tFlexibleStartDate as boolean,\n\t\tStartDate as string,\n\t\tCourseURL as string,\n\t\tCost as string,\n\t\tCostDescription as string,\n\t\tNational as boolean,\n\t\tRegions as string,\n\t\tVenueId as string,\n\t\tUpdatedDate as string,\n\t\tDurationUnit as string,\n\t\tDurationValue as string,\n\t\tAttendancePattern as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true) ~> courses\nsource(output(\n\t\tId as string,\n\t\tLocationAddress1 as string,\n\t\tLocationAddress2 as string,\n\t\tLocationCounty as string,\n\t\tLocationLatitude as double,\n\t\tLocationLongitude as double,\n\t\tLocationName as string,\n\t\tLocationPostcode as string,\n\t\tLocationTown as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true,\n\tquery: 'SELECT  c.id as Id\\n       ,c.VENUE_NAME as LocationName\\n       ,c.ADDRESS_1 as LocationAddress1\\n       ,c.ADDRESS_2 as LocationAddress2\\n       ,c.TOWN as LocationTown\\n       ,c.COUNTY as LocationCounty\\n       ,c.POSTCODE as LocationPostcode\\n       ,c.Latitude as LocationLatitude\\n       ,c.Longitude as LocationLongitude                                                 \\nFROM c',\n\tformat: 'documentQuery',\n\tsystemColumns: false) ~> Venues\nsource(output(\n\t\tId as string,\n\t\tApiLocationId as string,\n\t\tSubRegionName as string,\n\t\tChecked as boolean,\n\t\tLatitude as double,\n\t\tLongitude as double,\n\t\tWeighting as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false) ~> Regions\ncourses split(not(isNull(VenueId)),\n\tnot(isNull(Regions)),\n\tNational,\n\tdisjoint: false) ~> splitByLocationType@(CoursesWithVenues, RegionalCourses, NationalCourses, UnknownLocation)\nsplitByLocationType@CoursesWithVenues, Venues join(VenueId == Id,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> JoinCourseVenue\nJoinCourseVenue, splitByLocationType@RegionalCourses, splitByLocationType@NationalCourses union(byName: true)~> joinCourses\njoinCourses sort(asc(ProviderUKPRN, true),\n\tasc(CourseId, true)) ~> SortByProvider\nFlatten1, Regions join(Id == ERROR_FUNCTION(''),\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> Join1\nsplitByLocationType@RegionalCourses foldDown(mapColumn(\n\t\tProviderUKPRN,\n\t\tCourseId,\n\t\tLearnAimRef,\n\t\tCourseName,\n\t\tDeliveryMode,\n\t\tFlexibleStartDate,\n\t\tStartDate,\n\t\tCourseURL,\n\t\tCost,\n\t\tCostDescription,\n\t\tNational,\n\t\tRegions,\n\t\tVenueId,\n\t\tUpdatedDate,\n\t\tDurationUnit,\n\t\tDurationValue,\n\t\tAttendancePattern\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> Flatten1\nSortByProvider sink(input(\n\t\tProviderUkprn as string,\n\t\tCourseName as string,\n\t\tCourseId as string,\n\t\tLearnAimRef as string,\n\t\tDeliveryMode as string,\n\t\tStartDate as string,\n\t\tFlexibleStartDate as string,\n\t\tCourseURL as string,\n\t\tCost as string,\n\t\tCostDescription as string,\n\t\tRegions as string,\n\t\tNational as string,\n\t\tLocationName as string,\n\t\tLocationAddress1 as string,\n\t\tLocationAddress2 as string,\n\t\tLocationTown as string,\n\t\tLocationPostcode as string,\n\t\tLocationLatitude as string,\n\t\tLocationLongitude as string,\n\t\tUpdatedDate as string,\n\t\tDurationUnit as string,\n\t\tDurationValue as string,\n\t\tAttendanceType as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tpartitionFileNames:['courses.csv'],\n\tpartitionBy('hash', 1),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> coursesExport"
		}
	}
}